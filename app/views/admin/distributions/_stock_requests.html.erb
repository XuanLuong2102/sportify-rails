<div class="card">
  <div class="card-header bg-white">
    <h5 class="mb-0">
      <i class="fas fa-list"></i> <%= t('distribution.stock_requests_list') %>
    </h5>
  </div>
  <div class="card-body p-0">
    <% if @stock_requests.any? %>
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th><%= t('distribution.col_request_id') %></th>
              <th><%= t('distribution.col_place_name') %></th>
              <th><%= t('distribution.col_requester') %></th>
              <th><%= t('distribution.col_status') %></th>
              <th><%= t('distribution.col_created_date') %></th>
              <th><%= t('distribution.col_approved_date') %></th>
              <th><%= t('distribution.col_approver') %></th>
              <th><%= t('common.action') %></th>
            </tr>
          </thead>
          <tbody>
            <% @stock_requests.each do |request| %>
              <tr>
                <td>
                  <strong>#<%= request.id %></strong>
                </td>
                <td>
                  <strong><%= request.place&.name_en || 'N/A' %></strong>
                  <br/>
                  <small class="text-muted"><%= request.place&.name_vi %></small>
                </td>
                <td>
                  <% if request.requester %>
                    <strong><%= request.requester.first_name %> <%= request.requester.last_name %></strong>
                    <br/>
                    <small class="text-muted"><%= request.requester.email %></small>
                  <% else %>
                    N/A
                  <% end %>
                </td>
                <td>
                  <% status_class = case request.status
                    when 'pending'
                      'status-pending'
                    when 'approved'
                      'status-approved'
                    when 'rejected'
                      'status-rejected'
                    else
                      'status-pending'
                    end %>
                  <span class="status-badge <%= status_class %>">
                    <%= t("distribution.status_#{request.status}") %>
                  </span>
                </td>
                <td>
                  <div class="text-nowrap">
                    <strong><%= l(request.created_at, format: :short) %></strong>
                    <br/>
                    <small class="text-muted"><%= time_ago_in_words(request.created_at) %> <%= t('common.ago') %></small>
                  </div>
                </td>
                <td>
                  <% if request.approved_at || request.rejected_at %>
                    <div class="text-nowrap">
                      <strong><%= l(request.approved_at || request.rejected_at, format: :short) %></strong>
                      <br/>
                      <small class="text-muted"><%= time_ago_in_words(request.approved_at || request.rejected_at) %> <%= t('common.ago') %></small>
                    </div>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <% if request.approver %>
                    <strong><%= request.approver.first_name %> <%= request.approver.last_name %></strong>
                    <br/>
                    <small class="text-muted"><%= request.approver.email %></small>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <% if request.status == 'pending' %>
                    <div class="btn-group btn-group-sm" role="group">
                      <button 
                        type="button" 
                        class="btn btn-sm btn-success"
                        onclick="showApprovalModal(<%= request.id %>, 'Place: <%= request.place&.name_en %> | Items: <%= request.stock_request_items.count %>')">
                        <i class="fas fa-check"></i> <%= t('distribution.btn_approve') %>
                      </button>
                      <button 
                        type="button" 
                        class="btn btn-sm btn-danger"
                        onclick="showRejectionModal(<%= request.id %>, 'Place: <%= request.place&.name_en %>')">
                        <i class="fas fa-times"></i> <%= t('distribution.btn_reject') %>
                      </button>
                      <button 
                        type="button" 
                        class="btn btn-sm btn-outline-primary"
                        data-bs-toggle="collapse"
                        data-bs-target="#request-details-<%= request.id %>">
                        <i class="fas fa-eye"></i> <%= t('common.view_details') %>
                      </button>
                    </div>
                  <% else %>
                    <button 
                      type="button" 
                      class="btn btn-sm btn-outline-primary"
                      data-bs-toggle="collapse"
                      data-bs-target="#request-details-<%= request.id %>">
                      <i class="fas fa-eye"></i> <%= t('common.view_details') %>
                    </button>
                  <% end %>
                </td>
              </tr>
              <!-- Details Row -->
              <tr>
                <td colspan="8" class="p-0">
                  <div class="collapse" id="request-details-<%= request.id %>">
                    <div class="card card-body border-0 bg-light">
                      <h6 class="mb-3">
                        <strong><i class="fas fa-box"></i> <%= t('distribution.requested_items') %></strong>
                      </h6>
                      <% if request.stock_request_items.any? %>
                        <div class="table-responsive">
                          <table class="table table-sm table-borderless">
                            <thead class="table-light">
                              <tr>
                                <th><%= t('distribution.col_product') %></th>
                                <th class="text-end"><%= t('distribution.col_requested_quantity') %></th>
                              </tr>
                            </thead>
                            <tbody>
                              <% request.stock_request_items.each do |item| %>
                                <tr>
                                  <td>
                                    <% if item.product_variant&.product %>
                                      <strong><%= item.product_variant.product.name_en %></strong>
                                      <br/>
                                      <small class="text-muted">
                                        SKU: <%= item.product_variant.sku %>
                                        <% if item.product_variant.product_color %>
                                          | <%= item.product_variant.product_color.name %>
                                        <% end %>
                                        <% if item.product_variant.product_size %>
                                          | <%= item.product_variant.product_size.name %>
                                        <% end %>
                                      </small>
                                    <% else %>
                                      N/A
                                    <% end %>
                                  </td>
                                  <td class="text-end">
                                    <span class="badge bg-info"><%= item.requested_quantity %> <%= t('common.units') %></span>
                                  </td>
                                </tr>
                              <% end %>
                            </tbody>
                          </table>
                        </div>
                      <% else %>
                        <div class="alert alert-warning mb-0">
                          <small><%= t('distribution.no_items') %></small>
                        </div>
                      <% end %>

                      <% if request.note.present? %>
                        <hr class="my-3">
                        <h6 class="mb-2">
                          <strong><i class="fas fa-sticky-note"></i> <%= t('distribution.note') %></strong>
                        </h6>
                        <p class="mb-0 small"><%= simple_format(request.note) %></p>
                      <% end %>
                    </div>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <% if @stock_requests.total_pages > 1 %>
        <nav class="d-flex justify-content-center p-4">
          <%= paginate @stock_requests, param_name: :stock_requests_page %>
        </nav>
      <% end %>
    <% else %>
      <div class="alert alert-info m-4" role="alert">
        <i class="fas fa-info-circle"></i> <%= t('distribution.no_stock_requests') %>
      </div>
    <% end %>
  </div>
</div>
