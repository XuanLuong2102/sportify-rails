<div class="row">
  <div class="col-8">
    <h5><%= t('products.title.create') %></h5>
    
    <%= form_with model: [:admin, @product], local: true, multipart: true do |form| %>
      <% if @product.errors.any? %>
        <div class="alert alert-danger">
          <h4><%= pluralize(@product.errors.count, "error") %> prohibited this product from being saved:</h4>
          <ul>
            <% @product.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <div class="card mb-4">
        <div class="card-header fw-bold">Basic Information</div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-12 mb-3">
              <%= form.label :name_vi, t('products.name_vi'), class: 'form-label fw-bold' %>
              <%= form.text_field :name_vi, class: 'form-control', required: true %>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <%= form.label :name_en, "Product Name (English)", class: 'form-label fw-bold' %>
              <%= form.text_field :name_en, class: 'form-control', required: true, placeholder: "Auto-fill from Vietnamese name" %>
              <small class="text-muted">Auto-filled from Vietnamese name if left empty</small>
            </div>

            <div class="col-md-6 mb-3">
              <%= form.label :brand_id, t('products.brand'), class: 'form-label fw-bold' %>
              <%= form.select :brand_id, @brands, { include_blank: true }, class: 'form-select' %>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <%= form.label :category_id, t('products.category'), class: 'form-label fw-bold' %>
              <%= form.select :category_id, @categories, { include_blank: true }, class: 'form-select' %>
            </div>
          </div>

          <div class="mb-3">
            <%= form.label :description_vi, t('products.description_vi'), class: 'form-label fw-bold' %>
            <%= form.text_area :description_vi, class: 'form-control', rows: 5 %>
          </div>

          <div class="mb-3">
            <%= form.label :thumbnail, t('products.thumbnail'), class: 'form-label fw-bold' %>
            <%= form.file_field :thumbnail, class: 'form-control' %>
          </div>
        </div>
      </div>

      <!-- Size & Color Selection -->
      <div class="card mb-4">
        <div class="card-header fw-bold">Select Sizes & Colors</div>
        <div class="card-body">
          <div class="row mb-4">
            <div class="col-md-6">
              <label class="form-label fw-bold">Colors</label>
              <div class="color-selection d-flex flex-wrap gap-2">
                <% @colors.each do |color| %>
                  <button type="button" class="color-btn" 
                          data-color-id="<%= color.id %>" 
                          data-color-name="<%= color.name %>">
                    <span class="color-preview" style="display:inline-block; width:14px; height:14px; border-radius:50%; background-color:<%= color.code_rgb || '#999999' %>; border: 2px solid #999; margin-right:6px;"></span><%= color.name %>
                  </button>
                <% end %>
              </div>
              <input type="hidden" name="selected_colors" id="selected_colors" value="">
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">Sizes</label>
              <div class="size-selection d-flex flex-wrap gap-2">
                <% @sizes.each do |size| %>
                  <button type="button" class="size-btn" 
                          data-size-id="<%= size.id %>" 
                          data-size-name="<%= size.name %>">
                    <%= size.name %>
                  </button>
                <% end %>
              </div>
              <input type="hidden" name="selected_sizes" id="selected_sizes" value="">
            </div>
          </div>

          <!-- Selected Summary -->
          <div class="alert alert-info">
            <strong>Selected Combinations:</strong>
            <div id="selection-summary">
              <small class="text-muted">No selections yet</small>
            </div>
          </div>

          <!-- Base Price -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-bold">Base Price (VND) *</label>
              <%= form.number_field :base_price, class: 'form-control', step: 1000, required: true, placeholder: "Enter base price" %>
              <small class="text-muted">This price will be applied to all selected variants</small>
            </div>
          </div>
        </div>
      </div>

      <div class="d-grid gap-2">
        <%= form.submit class: 'btn btn-primary btn-lg' %>
        <%= link_to "Cancel", admin_products_path, class: "btn btn-secondary" %>
      </div>
    <% end %>
  </div>
</div>

<style>
  .color-btn,
  .size-btn {
    padding: 0.5rem 1rem;
    font-size: 0.95rem;
    cursor: pointer;
    border: 2px solid #dee2e6;
    background-color: #f8f9fa;
    color: #495057;
    transition: all 0.2s ease;
    border-radius: 0.375rem;
  }

  .color-btn:hover,
  .size-btn:hover {
    background-color: #e9ecef;
    border-color: #adb5bd;
  }

  .color-btn.active,
  .size-btn.active {
    background-color: #0d6efd !important;
    color: white !important;
    border-color: #0d6efd !important;
    box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
  }

  .color-preview {
    border: 2px solid #ddd;
    vertical-align: middle;
  }
</style>

<script>
  let selectedColorIds = [];
  let selectedSizeIds = [];

  document.addEventListener('DOMContentLoaded', function() {
    // Auto-fill name_en from name_vi
    const nameViInput = document.querySelector('input[name="product[name_vi]"]');
    const nameEnInput = document.querySelector('input[name="product[name_en]"]');
    
    if (nameViInput && nameEnInput) {
      nameViInput.addEventListener('change', function() {
        if (!nameEnInput.value) {
          nameEnInput.value = this.value;
        }
      });
    }

    const colorBtns = document.querySelectorAll('.color-btn');
    const sizeBtns = document.querySelectorAll('.size-btn');
    const selectedColorsInput = document.getElementById('selected_colors');
    const selectedSizesInput = document.getElementById('selected_sizes');
    const selectionSummary = document.getElementById('selection-summary');

    // Handle color selection
    colorBtns.forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const colorId = this.dataset.colorId;
        const index = selectedColorIds.indexOf(colorId);
        
        if (index > -1) {
          selectedColorIds.splice(index, 1);
          this.classList.remove('active');
        } else {
          selectedColorIds.push(colorId);
          this.classList.add('active');
        }
        
        updateSelections();
      });
    });

    // Handle size selection
    sizeBtns.forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const sizeId = this.dataset.sizeId;
        const index = selectedSizeIds.indexOf(sizeId);
        
        if (index > -1) {
          selectedSizeIds.splice(index, 1);
          this.classList.remove('active');
        } else {
          selectedSizeIds.push(sizeId);
          this.classList.add('active');
        }
        
        updateSelections();
      });
    });

    function updateSelections() {
      // Update hidden inputs
      selectedColorsInput.value = selectedColorIds.join(',');
      selectedSizesInput.value = selectedSizeIds.join(',');

      // Get color and size names
      const selectedColorNames = Array.from(colorBtns)
        .filter(btn => selectedColorIds.includes(btn.dataset.colorId))
        .map(btn => btn.dataset.colorName);
      
      const selectedSizeNames = Array.from(sizeBtns)
        .filter(btn => selectedSizeIds.includes(btn.dataset.sizeId))
        .map(btn => btn.dataset.sizeName);

      // Update summary
      updateSummary(selectedColorNames, selectedSizeNames);
    }

    function updateSummary(colors, sizes) {
      if (colors.length === 0 || sizes.length === 0) {
        selectionSummary.innerHTML = '<small class="text-muted">No selections yet</small>';
        return;
      }

      const combinations = [];
      colors.forEach(color => {
        sizes.forEach(size => {
          combinations.push(`${color} - ${size}`);
        });
      });

      const html = `
        <small>
          <strong>Total variants to create: ${combinations.length}</strong><br>
          ${combinations.map(c => `<span class="badge bg-info me-2">${c}</span>`).join('')}
        </small>
      `;
      selectionSummary.innerHTML = html;
    }
  });
</script>
